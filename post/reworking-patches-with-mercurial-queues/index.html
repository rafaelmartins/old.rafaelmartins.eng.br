<!DOCTYPE html>
<html lang="en-US">
    <head>
        <title>Rafael Martins » Post: Reworking patches with Mercurial Queues</title>
        <meta charset="utf-8" />
        <meta name="generator" content="blohg 0.13+/e8d8e6d" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link type="text/css" rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css" />
        <link type="text/css" rel="stylesheet" href="/static/custom.css" />
        <link type="text/css" rel="stylesheet" href="/static/pygments.css" />
        <!--[if lt IE 9]>
        <script src="/static/bootstrap/js/html5shiv.js"></script>
        <script src="/static/bootstrap/js/respond.min.js"></script>
        <![endif]-->
        <link rel="alternate" type="application/atom+xml" href="/atom.atom" title="Rafael Martins" />

<!-- begin opengraph header -->

<meta prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#" />
<meta property="og:site_name" content="Rafael Martins" />
<meta property="og:url" content="http://old.rafaelmartins.eng.br/post/reworking-patches-with-mercurial-queues/" />
<meta property="og:title" content="Rafael Martins » Post: Reworking patches with Mercurial Queues" />
<meta property="og:description" content="The first task of my GSoC project was to add XZ support to diffball, that is a tool that generates binary deltas for tarballs and binaries in general." />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2011-07-19T02:03:04Z" />
<meta property="article:modified_time" content="2014-01-19T01:31:57Z" />
<meta property="article:tag" content="en-us" />
<meta property="article:tag" content="mercurial" />
<meta property="article:tag" content="git" />
<meta property="article:tag" content="gsoc" />
<meta property="article:tag" content="gentoo" />
<meta property="article:tag" content="diffball" />

<!-- end opengraph header -->

<!-- begin disqus header -->

<script type="text/javascript">
    var disqus_shortname = "rafaelmartins-en";
    var disqus_url = "http://old.rafaelmartins.eng.br/post/reworking-patches-with-mercurial-queues/";
</script>

<!-- end disqus header -->

    </head>
    <body>
        <div class="navbar navbar-default navbar-fixed-top">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand" href="/">Rafael Martins</a>
                    <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
                <div class="navbar-collapse collapse" id="navbar-main">
                    <ul class="nav navbar-nav">
                        <li><a href="/posts/">Blog</a></li>
                        <li><a href="/about/">About</a></li>
                        <li><a href="/projects/">Projects</a></li>
                        <li><a href="/talks/">Talks</a></li>
                        <li><a href="/guitar-rig/">Guitar Rig</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="container">
            <div class="row">
                <div class="col-md-9">

<!-- begin content -->

<article>
    <h3><a href="/post/reworking-patches-with-mercurial-queues/">Reworking patches with Mercurial Queues</a></h3>

<!-- begin html parsed by docutils -->

<!-- tags: en-us,mercurial,git,gsoc,gentoo,diffball -->
<p>The first task of my <a class="reference external" href="http://www.gentoo.org/proj/en/infrastructure/distpatch/">GSoC project</a> was to add XZ support to diffball,
that is a tool that generates binary deltas for tarballs and binaries
in general.</p>
<p>diffball is versioned using <a class="reference external" href="http://git-scm.com/">Git</a>, that isn't something I like, personally.
I usually do <a class="reference external" href="http://git-scm.com/">Git</a> in the same way as I do CVS and other centralized version
control systems, resulting in a bad patch series.</p>
<p>As I don't know how to rework patches properly with <a class="reference external" href="http://git-scm.com/">Git</a>, I did it using
<a class="reference external" href="http://mercurial.selenic.com/wiki/MqExtension">Mercurial Queues</a> that are something I know better.</p>
<p>I'll show here how I reworked this patch series, as a mini-howto.</p>
<p>Enjoy :)</p>
<!-- read_more -->
<div class="section" id="enable-required-extensions">
<h4>Enable required extensions</h4>
<p>I needed 2 extensions, <a class="reference external" href="http://hg-git.github.com/">hg-git</a> and <a class="reference external" href="http://mercurial.selenic.com/wiki/MqExtension">mq</a>. The first one for work in <a class="reference external" href="http://git-scm.com/">Git</a>
repositories with <a class="reference external" href="http://mercurial.selenic.com/">Mercurial</a>, and the last one to work with <a class="reference external" href="http://mercurial.selenic.com/wiki/MqExtension">Mercurial Queues</a>.
<a class="reference external" href="http://hg-git.github.com/">hg-git</a> needs to be installed manually. <a class="reference external" href="http://mercurial.selenic.com/wiki/MqExtension">mq</a> is shipped with <a class="reference external" href="http://mercurial.selenic.com/">Mercurial</a>.</p>
<p>This is what I added to my ~/.hgrc file:</p>
<pre class="literal-block">
[extensions]
hggit =
mq =
</pre>
</div>
<div class="section" id="cloning-the-repository-and-creating-the-queue">
<h4>Cloning the repository and creating the queue</h4>
<p>I need to clone the repository and analyze the <a class="reference external" href="http://mercurial.selenic.com/">Mercurial</a> log:</p>
<pre class="literal-block">
$ hg clone git://pkgcore.org/diffball
$ cd diffball
$ hg log
changeset:   451:481ff769b7fb
bookmark:    personal/rafaelmartins/xz-support
tag:         default/personal/rafaelmartins/xz-support
tag:         tip
user:        Rafael G. Martins &lt;rafael&#64;rafaelmartins.eng.br&gt;
date:        Sun May 22 22:48:50 2011 -0300
summary:     actually added XZ functionality to libcfile.

changeset:   450:421a260e9f28
user:        Rafael G. Martins &lt;rafael&#64;rafaelmartins.eng.br&gt;
date:        Sun May 22 17:22:08 2011 -0300
summary:     fixed typo when enabling dcbuffer debug

changeset:   449:69a5b5d62cc1
user:        Rafael G. Martins &lt;rafael&#64;rafaelmartins.eng.br&gt;
date:        Sun May 22 13:22:28 2011 -0300
summary:     it's XZ, not LZMA.

changeset:   448:566bd0ffd47c
user:        Rafael G. Martins &lt;rafael&#64;rafaelmartins.eng.br&gt;
date:        Sun May 22 12:44:49 2011 -0300
summary:     added liblzma build system checks, using pkgconfig

changeset:   447:bf8e84c492de
user:        Rafael G. Martins &lt;rafael&#64;rafaelmartins.eng.br&gt;
date:        Sun May 22 12:33:32 2011 -0300
summary:     added LZMA auto-detection support.

changeset:   446:5797215cb97f
bookmark:    master
tag:         default/master
user:        Brian Harring &lt;brian.harring&#64;intel.com&gt;
date:        Thu Apr 07 13:52:26 2011 -0700
summary:     update copyright/license specifics

...
</pre>
<p>My commits are 447:451. I need to convert them to mq patches, after
initialize the mq repository:</p>
<pre class="literal-block">
$ hg init --mq
$ hg qimport --git -r 447:451
$ hg qseries
447.diff
448.diff
449.diff
450.diff
451.diff
</pre>
<p>Now I have 5 patches, with the local revision number as name. They are applied to
the original repository by default. I need to remove them before start re-adding
each one in the correct order:</p>
<pre class="literal-block">
$ hg qpop -a
</pre>
</div>
<div class="section" id="reworking-the-patches">
<h4>Reworking the patches</h4>
<p>I fixed a typo in the code that enable the dcbuffer debug. It's the 4th patch
in the original queue. As this patch isn't related to the XZ support I'm
implementing itself, I'll move it to the begin of the queue and rename it to
something better than the local revision number:</p>
<pre class="literal-block">
$ hg qpush --move 450.diff
applying 450.diff
now at: 450.diff
$ hg qmv 450.diff fixed-typo-when-enabling-dcbuffer-debug.diff
</pre>
<p>The patches <tt class="docutils literal">447.diff</tt> and <tt class="docutils literal">449.diff</tt> are related. I decided that I should
use the XZ name instead of LZMA, and changed the code of the first patch.
These 2 patches should be unified, creating a new patch:</p>
<pre class="literal-block">
$ patch -p1 &lt; .hg/patches/447.diff
patching file include/cfile.h
patching file libcfile/cfile.c
$ patch -p1 &lt; .hg/patches/449.diff
patching file include/cfile.h
patching file libcfile/cfile.c
$ hg qnew --git --currentuser --currentdate -m &quot;added XZ auto-detection support.&quot; added-xz-autodetection-support.diff
$ hg qdelete 447.diff 449.diff
</pre>
<p><tt class="docutils literal">.hg/patches</tt> is the <a class="reference external" href="http://mercurial.selenic.com/">Mercurial</a> repository that the extension uses to store
the patches. It was created by the <tt class="docutils literal">hg init <span class="pre">--mq</span></tt> command.</p>
<p>The patch <tt class="docutils literal">448.diff</tt> is ok, I'll just re-add it and rename:</p>
<pre class="literal-block">
$ hg qpush 448.diff
applying 448.diff
now at: 448.diff
$ hg qmv 448.diff added-liblzma-build-system-checks-using-pkgconfig.diff
</pre>
<p>The last unnaplied patch I have is <tt class="docutils literal">451.diff</tt>, that is good, but the commit
message isn't ok. I'll re-add it, change the commit message and rename it:</p>
<pre class="literal-block">
$ hg qpush 451.diff
applying 451.diff
now at: 451.diff
$ hg qrefresh -m &quot;added XZ functionality to libcfile.&quot;
$ hg qmv 451.diff added-xz-functionality-to-libcfile.diff
</pre>
<p>At this point I have a <a class="reference external" href="http://mercurial.selenic.com/">Mercurial</a> queue with the 4 reworked patches inside
<tt class="docutils literal">.hg/patches</tt>:</p>
<pre class="literal-block">
$ hg qseries
fixed-typo-when-enabling-dcbuffer-debug.diff
added-xz-autodetection-support.diff
added-liblzma-build-system-checks-using-pkgconfig.diff
added-xz-functionality-to-libcfile.diff
</pre>
<p>Commit the queue changes:</p>
<pre class="literal-block">
$ hg commit --mq -m &quot;added queue&quot;
</pre>
<p>I can publish it somewhere using the command:</p>
<pre class="literal-block">
$ hg push --mq $REMOTE_REPO_URL
</pre>
<p>My repository is here (broken url):</p>
<p><a class="reference external" href="http://hg.rafaelmartins.eng.br/mq/diffball">http://hg.rafaelmartins.eng.br/mq/diffball</a></p>
<p>This howto is far from perfect. I just wanted to give a quick introdution
for people that want to get started with this cool feature of <a class="reference external" href="http://mercurial.selenic.com/">Mercurial</a>. :)</p>
<p>That's all!</p>
<p>Thanks!</p>
</div>



<!-- end html parsed by docutils -->

    <div class="clear"></div>
    <div class="metadata well well-sm">
        <p><span class="label label-default"><a href="/tag/en-us/"><i class="glyphicon glyphicon-tag"></i> en-us</a></span> <span class="label label-default"><a href="/tag/mercurial/"><i class="glyphicon glyphicon-tag"></i> mercurial</a></span> <span class="label label-default"><a href="/tag/git/"><i class="glyphicon glyphicon-tag"></i> git</a></span> <span class="label label-default"><a href="/tag/gsoc/"><i class="glyphicon glyphicon-tag"></i> gsoc</a></span> <span class="label label-default"><a href="/tag/gentoo/"><i class="glyphicon glyphicon-tag"></i> gentoo</a></span> <span class="label label-default"><a href="/tag/diffball/"><i class="glyphicon glyphicon-tag"></i> diffball</a></span> </p>
        Author: <a href="mailto:rafael@rafaelmartins.eng.br">Rafael G. Martins</a>
        <br />
        Published on: Jul 19, 2011, 2:03:04 AM - Modified on: Jan 19, 2014, 1:31:57 AM
        <br />
        <a href="/post/reworking-patches-with-mercurial-queues/">Permalink</a> - <a href="/source/post/reworking-patches-with-mercurial-queues.txt">Source code</a> - <a href="/post/reworking-patches-with-mercurial-queues/#disqus_thread">Comments</a>
    </div>

<!-- start disqus post -->

<div id="disqus_thread"></div>
<script type="text/javascript">
    (function() {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = 'http://rafaelmartins-en.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
    Please enable JavaScript to view the
    <a href="http://disqus.com/?ref_noscript=rafaelmartins-en">
        comments powered by Disqus.
    </a>
</noscript>
<a href="http://disqus.com" class="dsq-brlink">
    blog comments powered by <span class="logo-disqus">Disqus</span>
</a>

<!-- end disqus post -->



<!-- start pagination -->


<!-- end pagination -->

<!-- end content -->

                </div>
                <div class="col-md-3 sidebar">
                    <div class="panel panel-default hidden-xs">
                        <div class="panel-heading">
                            <h4 class="panel-title">Blog Tags</h4>
                        </div>
                        <div class="panel-body tagcloud">
                            <span class="label label-default"><a href="/tag/bitbucket/"><i class="glyphicon glyphicon-tag"></i> bitbucket</a></span>
                            <span class="label label-default"><a href="/tag/blohg/"><i class="glyphicon glyphicon-tag"></i> blohg</a></span>
                            <span class="label label-default"><a href="/tag/celtic-folk/"><i class="glyphicon glyphicon-tag"></i> celtic-folk</a></span>
                            <span class="label label-default"><a href="/tag/collabora/"><i class="glyphicon glyphicon-tag"></i> collabora</a></span>
                            <span class="label label-default"><a href="/tag/diffball/"><i class="glyphicon glyphicon-tag"></i> diffball</a></span>
                            <span class="label label-default"><a href="/tag/electronics/"><i class="glyphicon glyphicon-tag"></i> electronics</a></span>
                            <span class="label label-default"><a href="/tag/en-us/"><i class="glyphicon glyphicon-tag"></i> en-us</a></span>
                            <span class="label label-default"><a href="/tag/engineering/"><i class="glyphicon glyphicon-tag"></i> engineering</a></span>
                            <span class="label label-default"><a href="/tag/events/"><i class="glyphicon glyphicon-tag"></i> events</a></span>
                            <span class="label label-default"><a href="/tag/fisl/"><i class="glyphicon glyphicon-tag"></i> fisl</a></span>
                            <span class="label label-default"><a href="/tag/g-octave/"><i class="glyphicon glyphicon-tag"></i> g-octave</a></span>
                            <span class="label label-default"><a href="/tag/gentoo/"><i class="glyphicon glyphicon-tag"></i> gentoo</a></span>
                            <span class="label label-default"><a href="/tag/git/"><i class="glyphicon glyphicon-tag"></i> git</a></span>
                            <span class="label label-default"><a href="/tag/google/"><i class="glyphicon glyphicon-tag"></i> google</a></span>
                            <span class="label label-default"><a href="/tag/gsoc/"><i class="glyphicon glyphicon-tag"></i> gsoc</a></span>
                            <span class="label label-default"><a href="/tag/lua/"><i class="glyphicon glyphicon-tag"></i> lua</a></span>
                            <span class="label label-default"><a href="/tag/mercurial/"><i class="glyphicon glyphicon-tag"></i> mercurial</a></span>
                            <span class="label label-default"><a href="/tag/music/"><i class="glyphicon glyphicon-tag"></i> music</a></span>
                            <span class="label label-default"><a href="/tag/oembed/"><i class="glyphicon glyphicon-tag"></i> oembed</a></span>
                            <span class="label label-default"><a href="/tag/pic/"><i class="glyphicon glyphicon-tag"></i> pic</a></span>
                            <span class="label label-default"><a href="/tag/pt-br/"><i class="glyphicon glyphicon-tag"></i> pt-br</a></span>
                            <span class="label label-default"><a href="/tag/pyoembed/"><i class="glyphicon glyphicon-tag"></i> pyoembed</a></span>
                            <span class="label label-default"><a href="/tag/python/"><i class="glyphicon glyphicon-tag"></i> python</a></span>
                            <span class="label label-default"><a href="/tag/random-stuff/"><i class="glyphicon glyphicon-tag"></i> random-stuff</a></span>
                            <span class="label label-default"><a href="/tag/scottish-folk/"><i class="glyphicon glyphicon-tag"></i> scottish-folk</a></span>
                            <span class="label label-default"><a href="/tag/stupid-stuff/"><i class="glyphicon glyphicon-tag"></i> stupid-stuff</a></span>
                        </div>
                    </div>
                    <div class="panel panel-default hidden-xs">
                        <div class="panel-heading">
                            <h4 class="panel-title">Under the hood</h4>
                        </div>
                        <div class="list-group">
                            <a class="list-group-item" href="http://blohg.org/">blohg</a>
                            <a class="list-group-item" href="http://git-scm.com/">Git</a>
                            <a class="list-group-item" href="http://www.gentoo.org/">Gentoo Linux</a>
                        </div>
                    </div>
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">Content License</h4>
                        </div>
                        <div class="panel-body">
                            <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">
                                <img alt="Creative Commons License" class="license"
                                    src="/static/creative-commons-88x31.png" />
                            </a>
                            This work is licensed under a <a rel="license"
                                href="http://creativecommons.org/licenses/by-nc/4.0/">
                                Creative Commons Attribution-NonCommercial 4.0 International License</a>.
                        </div>
                    </div>
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">Disclaimer</h4>
                        </div>
                        <div class="panel-body">
                            This is a personal weblog. The opinions expressed here represent my own
                            and not those of my employer, Gentoo Foundation or anyone else.
                        </div>
                    </div>
                </div>
            </div>
            <footer>
                <div class="row">
                    <div class="col-md-12">
                        <p>
                            Powered by: <a href="http://blohg.org/">blohg 0.13+/e8d8e6d</a>
                        </p>
                    </div>
                </div>
            </footer>
        </div>
        <script src="/static/bootstrap/js/jquery.min.js"></script>
        <script src="/static/bootstrap/js/bootstrap.min.js"></script>
        <script src="/static/resize.js"></script>

<!-- begin disqus footer -->

<script type="text/javascript">
    //<![CDATA[
    (function() {
        var links = document.getElementsByTagName('a');
        var query = '?';
        for(var i = 0; i < links.length; i++) {
            if(links[i].href.indexOf('#disqus_thread') >= 0) {
                query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
            }
        }
        document.write('<script charset="utf-8" type="text/javascript" src="http://disqus.com/forums/rafaelmartins-en/get_num_replies.js' + query + '"></' + 'script>');
    })();
    //]]>
</script>

<!-- end disqus footer -->

<!-- begin google analytics -->

<script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
    var pageTracker = _gat._getTracker("UA-2886928-8");
    pageTracker._initData();
    pageTracker._trackPageview();
</script>

<!-- end google analytics -->

    </body>
</html>